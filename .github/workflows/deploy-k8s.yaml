name: Deploy To Kubernetes

on:
  repository_dispatch:
    types: [ 'Continuous Deployment' ]

env:
  STATIC_IP_RG: 'MC_Demo.AKS_bcdemo_northeurope'
  IMAGE_REG: bcdemo.azurecr.io
  IMAGE_REPO: daprstore

jobs:
  deployStaging:
    runs-on: ubuntu-latest

    env:
      STATIC_IP: '20.191.56.121'
      ENV_NAME: "Kubernetes: Staging"
      NAMESPACE: 'daprstore-stage'

    steps:
      - name: 'Start deployment'
        id: deploy
        uses: abendigo/create-deployment@v1
        with:
          token: ${{ github.token }}
          environment: ${{ env.ENV_NAME }}

      - name: 'Checkout source'
        uses: actions/checkout@v1

      - name: 'Helm dependency update'
        run: |
          helm dep update ./deploy/helm/daprstore

      - name: 'Helm deploy to: ${{ env.ENV_NAME }}'
        uses: deliverybot/helm@v1
        env:
          KUBECONFIG_FILE: ${{ secrets.KUBE_CONFIG }}
        with:
          helm: helm3
          release: daprstore
          namespace: ${{ env.NAMESPACE }}
          chart: ./deploy/helm/daprstore
          values: |
            image:
              registry: ${{ env.IMAGE_REG }}
              repo: ${{ env.IMAGE_REPO }}
              tag: "${{ github.event.client_payload.imageTag }}"
            apiGateway:
              staticIP:
                address: "${{ env.STATIC_IP }}"
                resourceGroup: "${{ env.STATIC_IP_RG }}"

      - name: 'End deployment - success'
        if: ${{ success() }}
        uses: benc-uk/deployment-status@v1
        with:
          token: ${{ github.token }}
          state: success
          deployment_id: ${{ steps.deploy.outputs.id }}
          environment_url: http://${{ env.STATIC_IP }}/

      - name: 'End deployment - failure'
        if: ${{ failure() }}
        uses: benc-uk/deployment-status@v1
        with:
          token: ${{ github.token }}
          state: failure
          deployment_id: ${{ steps.deploy.outputs.id }}       

# ==============================================================================================

  deployProduction:
    runs-on: ubuntu-latest
    needs: deployStaging

    env:
      STATIC_IP: '20.191.56.9'
      ENV_NAME: 'Kubernetes: Production'
      NAMESPACE: 'daprstore-prod'

    steps:
      - run: echo ${{ toJSON(github.event) }}

      - name: 'Start deployment'
        id: deploy
        uses: abendigo/create-deployment@v1
        with:
          token: ${{ github.token }}
          environment: ${{ env.ENV_NAME }}

      - name: 'Checkout source'
        uses: actions/checkout@v1

      - name: 'Helm dependency update'
        run: |
          helm dep update ./deploy/helm/daprstore

      - name: 'Helm deploy to: ${{ env.ENV_NAME }}'
        uses: deliverybot/helm@v1
        env:
          KUBECONFIG_FILE: ${{ secrets.KUBE_CONFIG }}
        with:
          helm: helm3
          release: daprstore
          namespace: ${{ env.NAMESPACE }}
          chart: ./deploy/helm/daprstore
          values: |
            image:
              registry: ${{ env.IMAGE_REG }}
              repo: ${{ env.IMAGE_REPO }}
              tag: "${{ github.event.client_payload.imageTag }}"
            apiGateway:
              staticIP:
                address: "${{ env.STATIC_IP }}"
                resourceGroup: "${{ env.STATIC_IP_RG }}"

      - name: 'End deployment - success'
        if: ${{ success() }}
        uses: benc-uk/deployment-status@v1
        with:
          token: ${{ github.token }}
          state: success
          deployment_id: ${{ steps.deploy.outputs.id }}  
          environment_url: http://${{ env.STATIC_IP }}/

      - name: 'End deployment - failure'
        if: ${{ failure() }}
        uses: benc-uk/deployment-status@v1
        with:
          token: ${{ github.token }}
          state: failure
          deployment_id: ${{ steps.deploy.outputs.id }}    