name: Deploy To Kubernetes

on:
  workflow_dispatch:
    inputs:
      IMAGE_TAG:
        description: "Image tag to deploy"
        required: true
        default: "latest"

env:
  IMAGE_REG: ghcr.io
  NAMESPACE: dapr-store

jobs:
  deployStaging:
    runs-on: ubuntu-latest

    env:
      STATIC_IP: "20.191.56.121"
      NAMESPACE: "dapr-store"
      HOST: "dapr-store.kube.benco.io"

    steps:
      - name: "Checkout source"
        uses: actions/checkout@v2

      - name: "Helm deploy Redis"
        uses: deliverybot/helm@master
        env:
          KUBECONFIG_FILE: ${{ secrets.KUBE_CONFIG }}
        with:
          helm: helm3
          release: redis
          namespace: ${{ env.NAMESPACE }}
          chart: redis
          repository: https://charts.bitnami.com/bitnami
          values: |
            fullnameOverride: daprstore-redis
            enabled: true
            usePassword: false
            cluster:
              enabled: false
            master:
              persistence:
                enabled: false

      # - run: sleep 10

      # - name: "Helm deploy Daprstore to staging"
      #   uses: deliverybot/helm@master
      #   env:
      #     KUBECONFIG_FILE: ${{ secrets.KUBE_CONFIG }}
      #   with:
      #     helm: helm3
      #     release: daprstore
      #     namespace: ${{ env.NAMESPACE }}
      #     chart: ./deploy/helm/daprstore
      #     values: |
      #       image:
      #         registry: ${{ env.IMAGE_REG }}
      #         repo: ${{ env.IMAGE_REPO }}
      #         tag: "${{ github.event.client_payload.imageTag }}${{ github.event.inputs.imageTag }}"
      #       ingress:
      #         host: "${{ env.HOST }}"

      # - name: "Helm deploy Nginx ingress to staging"
      #   uses: deliverybot/helm@master
      #   env:
      #     KUBECONFIG_FILE: ${{ secrets.KUBE_CONFIG }}
      #   with:
      #     helm: helm3
      #     release: api-gateway-stage
      #     namespace: ${{ env.NAMESPACE }}
      #     repository: https://kubernetes.github.io/ingress-nginx
      #     chart: ingress-nginx
      #     value-files: ./deploy/ingress/chart-values.yaml
      #     values: |
      #       controller:
      #         service:
      #           loadBalancerIP: "${{ env.STATIC_IP }}"
      #         scope:
      #           namespace: ${{ env.NAMESPACE }}

      # - name: "Run API tests"
      #   uses: matt-ball/newman-action@master
      #   with:
      #     collection: ./testing/postman_collection.json
      #     # Can't set this without a file, kinda lame
      #     environment: ./testing/postman_env_staging.json
