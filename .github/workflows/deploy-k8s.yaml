name: Deploy To Kubernetes

on:
  repository_dispatch:
    types: [ 'Continuous Deployment' ]

env:
  IMAGE_REG: bcdemo.azurecr.io
  IMAGE_REPO: daprstore

jobs:
  deployStaging:
    runs-on: ubuntu-latest

    env:
      STATIC_IP: '20.191.56.121'
      ENV_NAME: "Kubernetes: Staging"
      NAMESPACE: 'daprstore-stage'

    steps:
      - name: 'Start deployment'
        id: deploy
        uses: abendigo/create-deployment@v1
        with:
          token: ${{ github.token }}
          environment: ${{ env.ENV_NAME }}

      - name: 'Checkout source'
        uses: actions/checkout@v1

      - name: 'Helm dependency update'
        run: |
          helm dep update ./deploy/helm/daprstore
          helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx

      - name: 'Helm deploy ingress to staging'
        uses: deliverybot/helm@v1
        env:
          KUBECONFIG_FILE: ${{ secrets.KUBE_CONFIG }}
        with:
          helm: helm3
          release: api-gateway-stage
          namespace: ${{ env.NAMESPACE }}
          chart: ingress-nginx/ingress-nginx 
          values: |
            controller:
              service:
                loadBalancerIP: "${{ env.STATIC_IP }}"
              scope:
                namespace: ${{ env.NAMESPACE }}

      - name: 'Helm deploy Daprstore to staging'
        uses: deliverybot/helm@v1
        env:
          KUBECONFIG_FILE: ${{ secrets.KUBE_CONFIG }}
        with:
          helm: helm3
          release: daprstore
          namespace: ${{ env.NAMESPACE }}
          chart: ./deploy/helm/daprstore
          values: |
            image:
              registry: ${{ env.IMAGE_REG }}
              repo: ${{ env.IMAGE_REPO }}
              tag: "${{ github.event.client_payload.imageTag }}"

      - name: 'End deployment - success'
        if: ${{ success() }}
        uses: benc-uk/deployment-status@v1
        with:
          token: ${{ github.token }}
          state: success
          deployment_id: ${{ steps.deploy.outputs.id }}
          environment_url: http://${{ env.STATIC_IP }}/

      - name: 'End deployment - failure'
        if: ${{ failure() }}
        uses: benc-uk/deployment-status@v1
        with:
          token: ${{ github.token }}
          state: failure
          deployment_id: ${{ steps.deploy.outputs.id }}       

# ==============================================================================================

  deployProduction:
    runs-on: ubuntu-latest
    needs: deployStaging

    env:
      STATIC_IP: '20.191.56.9'
      ENV_NAME: 'Kubernetes: Production'
      NAMESPACE: 'daprstore-prod'

    steps:
      - name: 'Start deployment'
        id: deploy
        uses: abendigo/create-deployment@v1
        with:
          token: ${{ github.token }}
          environment: ${{ env.ENV_NAME }}

      - name: 'Checkout source'
        uses: actions/checkout@v1

      - name: 'Helm dependency update'
        run: |
          helm dep update ./deploy/helm/daprstore
          helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx

      - name: 'Helm deploy ingress to production'
        uses: deliverybot/helm@v1
        env:
          KUBECONFIG_FILE: ${{ secrets.KUBE_CONFIG }}
        with:
          helm: helm3
          release: api-gateway-prod
          namespace: ${{ env.NAMESPACE }}
          chart: ingress-nginx/ingress-nginx 
          values: |
            controller:
              service:
                loadBalancerIP: "${{ env.STATIC_IP }}"
              scope:
                namespace: ${{ env.NAMESPACE }}

      - name: 'Helm deploy Daprstore to production'
        uses: deliverybot/helm@v1
        env:
          KUBECONFIG_FILE: ${{ secrets.KUBE_CONFIG }}
        with:
          helm: helm3
          release: daprstore
          namespace: ${{ env.NAMESPACE }}
          chart: ./deploy/helm/daprstore
          values: |
            auth:
              clientId: "69972365-c1b6-494d-9579-5b9de2790fc3"
            image:
              registry: ${{ env.IMAGE_REG }}
              repo: ${{ env.IMAGE_REPO }}
              tag: "${{ github.event.client_payload.imageTag }}"

      - name: 'End deployment - success'
        if: ${{ success() }}
        uses: benc-uk/deployment-status@v1
        with:
          token: ${{ github.token }}
          state: success
          deployment_id: ${{ steps.deploy.outputs.id }}  
          environment_url: http://${{ env.STATIC_IP }}/

      - name: 'End deployment - failure'
        if: ${{ failure() }}
        uses: benc-uk/deployment-status@v1
        with:
          token: ${{ github.token }}
          state: failure
          deployment_id: ${{ steps.deploy.outputs.id }}    